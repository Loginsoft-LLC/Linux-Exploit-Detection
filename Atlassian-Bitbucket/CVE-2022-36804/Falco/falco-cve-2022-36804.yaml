- list: shell_binaries
  items: [ash, bash, csh, ksh, sh, tcsh, zsh, dash]

- macro: bitbucket_environment_variables
  condition: (proc.env contains 'BITBUCKET_HOME' and proc.env contains 'BITBUCKET_INSTALL_DIR' and proc.env contains 'BITBUCKET_USER')

- rule: Bitbucket Unauthenticated Remote Code Execution CVE-2022-36804 Exploited
  desc: Detecs the execution of system commands using git. Possible exploitation of CVE-2022-36804.
  condition: >
    evt.dir=< and
    evt.type=execve and 
    proc.name in (shell_binaries) and 
    proc.pname=git and 
    bitbucket_environment_variables and
    proc.args startswith "-c" and 
    proc.args  contains "/'"
  output: "CVE-2022-36804 exploit attempt detected (user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name proc.cwd=%proc.cwd container.id=%container.id)"
  priority: CRITICAL
  tags: [host,container,exploit,CVE_2022_36804,bitbucket,Mitre_Initial_Access, T1190] 
