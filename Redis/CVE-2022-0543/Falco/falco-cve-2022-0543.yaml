- required_engine_version: 17


- list: shell_binaries
  items: [ash, bash, csh, ksh, sh, tcsh, zsh, dash]

- macro: shell_procs
  condition: proc.name in (shell_binaries)

- macro: spawned_process
  condition: (evt.type in (execve, execveat) and evt.dir=<)

- rule: Redis Lua sandbox escape RCE CVE-2022-0543
  desc: Redis Lua sandbox escape leads to remote code execution CVE-2022-0543
  condition: >
    spawned_process and
    proc.pname=redis-server and
    shell_procs
  output: "Redis CVE-2022-0543 (user=%user.name shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline pid=%proc.pid pcmdline=%proc.pcmdline container_id=%container.id)"
  priority: CRITICAL
  tags: [host, container, redis, CVE_2022_0543, Mitre_Initial_Access, T1210]


- rule: Redis Lua sandbox escape Remote code execution CVE-2022-0543
  desc: Redis Lua sandbox escape leads to remote code execution CVE-2022-0543
  condition: >
    evt.dir=< and
    evt.type=read and
    proc.name=redis-server and
    evt.args contains 'package.loadlib(' and
    evt.args contains 'io.popen'
  output: "Redis CVE-2022-0543 (user=%user.name shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline pid=%proc.pid pcmdline=%proc.pcmdline container_id=%container.id)"
  priority: CRITICAL
  tags: [host, container, redis, CVE_2022_0543, Mitre_Initial_Access, T1210]
 
