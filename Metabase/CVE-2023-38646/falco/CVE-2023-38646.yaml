- required_engine_version: 17

- macro: read_socket
  condition: (fd.typechar='4' or fd.typechar='6')

- macro: is_metabase
  condition: (proc.env contains MB_DB_PASS or proc.env contains MB_LDAP_BIND_DN)


- macro: metabase_rce_request
  condition: (evt.arg.data contains 'POST' and 
              evt.arg.data contains '/api/setup/validate' and 
              evt.arg.data contains '"details"' and 
              evt.arg.data contains '"token"' and 
              evt.arg.data contains '.exec')


- rule: Metabase Possible Remote Code Execution CVE-2023-38646
  desc: Possible Metabase Remote Code Execution CVE-2023-38646.
  condition: >
    evt.dir=< and 
    is_metabase and 
    metabase_rce_request
  output: "CVE-2023-38646 (Metabase) Possible Remote Code Execution detected (user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name container.id=%container.id evt.args=%evt.args)"
  priority: CRITICAL
  tags: [host, container, exploit, CVE_2023_38646, atlassian_confluence, Mitre_Initial_Access, T1190]


- rule: Metabase Possible Authentication Bypass CVE-2023-38646
  desc: Metabase Possible Authentication Bypass CVE-2023-38646.
  condition: >
    evt.dir=< and 
    is_metabase and 
    evt.arg.data contains '/api/session/properties'
  output: "CVE-2023-38646 (Metabase) Possible Authentication Bypass detected (user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name container.id=%container.id evt.args=%evt.args)"
  priority: ALERT
  tags: [host, container, exploit, CVE_2023_38646, atlassian_confluence, Mitre_Initial_Access, T1190]
