SELECT
    p.name AS process_name,
    p.pid AS process_pid,
    p.cmdline AS process_cmdline,
    p.path AS process_path,
    pof.path AS opened_files,
    yara.count,
    yara.matches
FROM processes p
JOIN process_open_files AS pof
ON p.pid = pof.pid
AND name = 'java'
AND cmdline LIKE '%rocketmq%'
AND pof.path LIKE '%/broker.log'
JOIN yara
ON yara.path = pof.path
AND yara.count > 0
AND sigrule = '
    rule rocketmq_2023_33246_log{
        meta:
            author = "Loginsoft Research Team"
            description = "Detect the updatebrokerconfig request to add keys before exploitation from broker.log file"
        strings:
            $update_info_1 = "Broker receive request to update config, caller address"
            $update_info_2 = "updateBrokerConfig called by"
            $update_key_info = /updateBrokerConfig, new config: \[\{filterServerNums=(0*[1-9]\d*|0\d{*,}), rocketmqHome=-c/

        condition:
            1 of ($update_info_*) and $update_key_info
    }';
