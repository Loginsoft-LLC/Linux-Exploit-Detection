package confluence.cve_2022_26134

import data.tracee.helpers


__rego_metadoc__ := {
  "id": "cve_2022_26134",
  "version": "0.1.0",
  "name": "cve_2022_26134 exploit detection",
  "eventName":  "cve_2022_26134_rce",
  "description": "Possible CVE-2022-26134 Attempt exploit attempt observed",
  "tags": ["linux", "container"],
  "properties": {
    "Severity": 2,
    "MITRE ATT&CK": "Initial Access: Exploit Public-Facing Application",
  },
}


eventSelectors := [
  {
    "source": "tracee",
    "name": "net_packet_http_response",
    "origin": "*",
  },
]


tracee_selected_events[eventSelector] {
  eventSelector := eventSelectors[_]
}



proc_http_nio {
  pname := input.processName
  contains(pname, "http-nio")
}



tracee_match = res  {
  input.eventName == "net_packet_http_response"
  http_response := helpers.get_tracee_argument("http_response")
  http_response.status_code == 302
  response_redirect := http_response.headers.Location[0]
  regex.match(`org\.apache\.commons\.io\.IOUtils\S+toString\S+java\.lang\.Runtime\S+.exec|javax\.script\.ScriptEngineManager\S+\.eval\S+java\.lang\.ProcessBuilder\S+\.command`, response_redirect)
  proc_http_nio with input as input
  res := {
      "caught_signature_from": http_response.headers.Location[0]
  }
}
