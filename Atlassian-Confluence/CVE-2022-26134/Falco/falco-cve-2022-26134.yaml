
- list: shell_binaries
  items: [ash, bash, csh, ksh, sh, tcsh, zsh, dash]


- macro: check_process_atlassian_confluence
  condition: (proc.aname[0]=java and proc.name contains http-nio and proc.cmdline contains -DConfluence)


- rule: Atlassian Confluence Server and Data Center Possible CVE-2022-26134 Exploit Detection(RCE)
  desc: Possible CVE-2022-26134 Attempt exploit observed. 
  condition: >
    evt.dir=< and 
    evt.type in (stat, execve) and 
    check_process_atlassian_confluence and 
    (evt.arg.path contains 'java.lang.Runtime@getRuntime().exec' or evt.arg.path contains '${new javax.script.ScriptEngineManager().getEngineByName("nashorn").eval') or (evt.arg.exe in (shell_binaries) and evt.arg.args startswith '-c')
  output: "CVE-2022-26134 (Atlassian Confluence) exploit detected (user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name proc.cwd=%proc.cwd container.id=%container.id evt.args=%evt.args)"
  priority: CRITICAL
  tags: [host, container, exploit, CVE_2022_26134, atlassian_confluence, Mitre_Initial_Access, T1190]


- macro: read_socket
  condition: evt.type=read and (fd.typechar='4' or fd.typechar='6')


- rule: Atlassian Confluence Server and Data Center CVE-2022-26134 Exploit Attempt Detection(RCE)
  desc: Possible CVE-2022-26134 Attempt exploit attempt observed. 
  condition: >
    evt.dir=< and 
    read_socket and 
    check_process_atlassian_confluence and 
    (evt.arg.data contains 'org.apache.commons.io.IOUtils' and evt.arg.data contains 'java.lang.Runtime' and evt.arg.data contains '.exec') or
    (evt.arg.data contains 'javax.script.ScriptEngineManager' and evt.arg.data contains 'getEngineByName' and evt.arg.data contains '.eval' and evt.arg.data contains 'java.lang.ProcessBuilder' and evt.arg.data contains '.command')

  output: "CVE-2022-26134 (Atlassian Confluence) exploit attempt detected (user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name proc.cwd=%proc.cwd container.id=%container.id evt.args=%evt.args cip=%fd.cip)"
  priority: CRITICAL
  tags: [host, container, exploit, CVE_2022_26134, atlassian_confluence, Mitre_Initial_Access, T1190]














