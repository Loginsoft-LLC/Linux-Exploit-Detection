- required_engine_version: 17

- macro: read_socket
  condition: evt.type=read and (fd.typechar='4' or fd.typechar='6')

- macro: check_process_atlassian_confluence
  condition: (proc.aname[0]=java and proc.name contains http-nio and proc.cmdline contains -DConfluence)

- macro: java_system_command
  condition: (evt.arg.data contains 'java.lang.ProcessBuilder' or evt.arg.data contains 'java.lang.Runtime' or evt.arg.data contains 'java.lang.getRuntime')

- macro: cve_2021_26084_vulnerable_endpoints
  condition: (
    evt.arg.data contains createpage-entervariables.action or
    evt.arg.data contains 'pages/createpage.action' or
    evt.arg.data contains 'pages/createpage.action?spaceKey=' or
    evt.arg.data contains 'pages/templates2/viewpagetemplate.action' or
    evt.arg.data contains 'template/custom/content-editor' or
    evt.arg.data contains 'templates/editor-preload-container' or 
    evt.arg.data contains '/users/user-dark-features' or 
    evt.arg.data contains '/pages/doenterpagevariables.action')

- rule: Atlassian Confluence Server and Data Center OGNL injection vulnerability CVE-2021-26084
  desc: Possible CVE-2021-26084 execute arbitrary code exploit Attempt observed. 
  condition: >
    evt.dir=< and 
    read_socket and 
    check_process_atlassian_confluence and 
    cve_2021_26084_vulnerable_endpoints and
    evt.arg.data contains 'POST 'and java_system_command
  output: "CVE-2021-26084 (Atlassian Confluence) Remote Code Execution detected(user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name container.id=%container.id evt.args=%evt.args)"
  priority: CRITICAL
  tags: [host, container, exploit, CVE_2021_26084, atlassian_confluence, Mitre_Initial_Access, T1190]
