- required_engine_version: 17

- macro: read_socket
  condition: evt.type=read and (fd.typechar='4' or fd.typechar='6')

- macro: check_process_atlassian_confluence
  condition: (proc.aname[0]=java and proc.name contains http-nio and proc.cmdline contains -DConfluence)


- rule: Atlassian Confluence Server Possible CVE-2023-22515 Exploit Detection 
  desc: Request to overwrite the setup attribute attempt observed CVE-2023-22515
  condition: >
    evt.dir=< and 
    read_socket and 
    check_process_atlassian_confluence and 
    evt.arg.data contains GET and evt.arg.data contains '/server-info.action' and evt.arg.data contains 'setupComplete=false'
  output: "CVE-2023-22515 (Atlassian Confluence) exploit detected, privilege escalation vulnerability (user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name container.id=%container.id evt.args=%evt.args)"
  priority: ALERT
  tags: [host, container, exploit, CVE_2023_22515, atlassian_confluence, Mitre_Initial_Access, T1190]


- rule: Atlassian Confluence Server Possible CVE-2023-22515 Exploit Detection
  desc: Administrator user creation CVE-2023-22515 Possible exploit attempt observed
  condition: >
    evt.dir=< and 
    read_socket and
    check_process_atlassian_confluence and 
    evt.arg.data contains POST and evt.arg.data contains 'setupadministrator.action' and evt.arg.data contains 'username' and evt.arg.data contains 'fullName' and evt.arg.data contains 'password' and evt.arg.data contains 'setup-next-button'
  output: "CVE-2023-22515 (Atlassian Confluence) exploit detected, privilege escalation vulnerability (user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name container.id=%container.id evt.args=%evt.args)"
  priority: CRITICAL
  tags: [host, container, exploit, CVE_2023_22515, atlassian_confluence, Mitre_Initial_Access, T1190]
