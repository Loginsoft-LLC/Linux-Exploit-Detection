- required_engine_version: 17

- macro: cacti_php_execution
  condition: (evt.arg.args contains "/php" and evt.arg.args contains " -q " and evt.arg.args contains "script_server.php" and evt.arg.args contains "realtime")

- macro: unix_shell_escape
  condition: >
    evt.args contains "`" or
    evt.args contains ";" or
    evt.args contains "|" or
    evt.args contains "$(" or
    evt.args contains "&&"

- rule: Cacti Unauthenticated Remote Code Execution CVE-2022-46169
  desc: Detects Possible execution of system commands using Cacti CVE-2022-46169
  condition: >
    evt.dir=< and
    evt.type=execve and
    cacti_php_execution and
    unix_shell_escape and
    proc.pname=apache2
  output: "CVE-2022-46169 exploit attempt detected (user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name proc.cwd=%proc.cwd container.id=%container.id)"
  priority: CRITICAL
  tags: [host, container, CVE_2022_46169, cacti, Mitre_Initial_Access, T1190]


- macro: read_socket
  condition: evt.type=read and (fd.typechar='4' or fd.typechar='6')

- macro: cacti_http_request
  condition: (evt.arg.data contains 'remote_agent.php' and evt.arg.data contains 'host_id=' and evt.arg.data contains 'poller_id=')

- macro: cacti_http_headers
  condition: >
    evt.arg.data contains 'X-Forwarded' or
    evt.arg.data contains 'X-Forwarded-For' or
    evt.arg.data contains 'X-Cluster-Client-IP' or
    evt.arg.data contains 'Forwarded-For' or
    evt.arg.data contains 'Forwarded' or
    evt.arg.data contains 'Client-IP'

- rule: Cacti Unauthenticated Remote Code Execution CVE-2022-46169
  desc: Detects Possible execution of system commands using Cacti CVE-2022-46169
  condition: >
    read_socket and cacti_http_request and cacti_http_headers
  output: "CVE-2022-46169 exploit attempt detected (user.name=%user.name user.loginuid=%user.loginuid proc.name=%proc.name proc.cwd=%proc.cwd container.id=%container.id)"
  priority: WARNING
  tags: [host, container, CVE_2022_46169, cacti, Mitre_Initial_Access, T1190]
