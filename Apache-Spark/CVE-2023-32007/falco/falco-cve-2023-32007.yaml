- required_engine_version: 17

- macro: unix_shell_escape
  condition: >
    evt.args contains "`" or
    evt.args contains ";" or
    evt.args contains "|" or
    evt.args contains "$(" or
    evt.args contains "&&"

- macro: apache_spark_env
  condition: (proc.env contains 'SPARK_SSL_PROTOCOL' and proc.env contains 'SPARK_MASTER_URL' and proc.env contains 'SPARK_BASEDIR')

- rule: Apache Spark Remote Code Execution CVE-2022-33891/CVE-2023-32007
  desc: Detects Possible execution of system commands using Apache Spark CVE-2022-33891/CVE-2023-32007
  condition: >
    evt.dir=< and
    evt.type=execve and
    evt.args contains 'id -Gn' and
    proc.name=bash and
    unix_shell_escape and
    apache_spark_env
  output: "CVE-2022-33891/CVE-2023-32007 exploit attempt detected (user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name proc.cwd=%proc.cwd container.id=%container.id)"
  priority: CRITICAL
  tags: [host, container, CVE_2022_33891, CVE_2023_32007, apache_spark, Mitre_Initial_Access, T1190]
    
- macro: apache_spark_sus_char_response
  condition: >
    evt.args contains "HTTP ERROR 403 User `" or
    evt.args contains "HTTP ERROR 403 User ;" or
    evt.args contains "HTTP ERROR 403 User |" or
    evt.args contains "HTTP ERROR 403 User $(" or
    evt.args contains "HTTP ERROR 403 User &amp;&amp;"

- macro: writev_socket
  condition: evt.type=writev and (fd.typechar='4' or fd.typechar='6')

- rule: Apache Spark Remote Code Execution CVE-2022-33891/CVE-2023-32007
  desc: Detects Possible execution of system commands using Apache Spark CVE-2022-33891/CVE-2023-32007
  condition: >
    writev_socket and
    apache_spark_sus_char_response and
    evt.args contains '403 Forbidden'
  output: "CVE-2022-33891/CVE-2023-32007 exploit attempt detected (user.name=%user.name user.loginuid=%user.loginuid proc.exeline=%proc.exeline proc.name=%proc.name proc.cwd=%proc.cwd container.id=%container.id)"
  priority: CRITICAL
  tags: [host, container, CVE_2022_33891, CVE_2023_32007, apache_spark, Mitre_Initial_Access, T1190]
