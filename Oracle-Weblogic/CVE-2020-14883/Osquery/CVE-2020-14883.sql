SELECT
    p.name AS process_name,
    p.pid AS process_pid,
    p.cmdline AS process_cmdline,
    p.path AS process_path,
    pof.path AS opened_files,
    yara.count,
    yara.matches
FROM processes p
JOIN process_open_files AS pof
ON p.pid = pof.pid
AND name = 'java'
AND cmdline LIKE '%com.oracle.classloader.weblogic%'
AND pof.path LIKE '%.log'
JOIN yara
ON yara.path = pof.path
AND count > 0
AND sigrule = '
    rule weblogic_vuln {
        meta:
            author = "Loginsoft Research Team"
            description = "Detect indicator of compromise for weblogic vulnerability CVE-2020-14883 in log files"
        strings:
            $servlet_exception = "weblogic.security.service.InvalidParameterException: Unable to instanciate handle type"
            $handle_1 = "com.tangosol.coherence.mvel2.sh.ShellSession"
            $handle_2 = "com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext"
            $url_path_1 = "/console/%2e%2e%2fconsole.portal" nocase
            $url_path_2 = "/console/../../console.portal"
        condition:
            ($servlet_exception and 1 of ($handle_*))
            or ($servlet_exception and 1 of ($handle_*) and 1 of ($url_path_*))
    }';