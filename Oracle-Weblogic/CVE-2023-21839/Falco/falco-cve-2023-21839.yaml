- required_engine_version: 17


- macro: read_socket
  condition: (evt.type=readv or evt.type=read) and (fd.typechar='4' or fd.typechar='6')

- macro: java_system_command_getRuntime
  condition: (evt.arg.data contains 'Runtime' and evt.arg.data contains 'getRuntime' and evt.arg.data contains '.exec(' )

- macro: java_system_command_processBuilder
  condition: (evt.arg.data contains 'ProcessBuilder' and evt.arg.data contains '.start(')

- rule: Oracle Weblogic Server Unauthenticated Remote Code Execution CVE-2023-21839
  desc: Detection the execution of system commands using Oracle Weblogic Server. Possible exploitation of CVE-2023-21839.
  condition: >
    evt.dir=< and
    read_socket and
    evt.buffer bstartswith 'CAFEBABE' and
    (evt.arg.data contains 'ProcessBuilder.Command(' or
    java_system_command_getRuntime or
    java_system_command_processBuilder) and
    proc.name=java and 
    proc.exeline contains '-Dweblogic'
  output: "CVE-2023-21839 Remote Code Execution detected (event=%evt.type server_ip=%fd.sip server_port=%fd.sport proto=%fd.l4proto fd.cip=%fd.cip user.name=%user.name user.loginuid=%user.loginuid parent=%proc.pname process=%proc.name evt.args=%evt.args container_id=%container.id)"
  priority: CRITICAL
  tags: [host , container, CVE_2023_21839, weblogic, Mitre_Initial_Access, T1190]


- macro: weblogic_class_path_check
  condition: (evt.arg.path endswith .class and evt.arg.path contains 'base_domain' and evt.arg.path contains 'user_projects')

- rule: Oracle Weblogic Server Unauthenticated Remote Code Execution CVE-2023-21839
  desc: Detection the execution of system commands using Oracle Weblogic Server. Possible exploitation of CVE-2023-21839.
  condition: >
    proc.name=java and
    evt.type=stat and
    evt.arg.path contains '.class' and
    evt.res=ENOENT and
    proc.pcmdline contains '-Dweblogic'
  output: "CVE-2023-21839 Remote Code Execution detected (event=%evt.type server_ip=%fd.sip server_port=%fd.sport proto=%fd.l4proto fd.cip=%fd.cip user.name=%user.name user.loginuid=%user.loginuid parent=%proc.pname process=%proc.name evt.arg.path=%evt.arg.path container_id=%container.id)"
  priority: CRITICAL
  tags: [host , container, CVE_2023_21839, weblogic, Mitre_Initial_Access, T1190]


- rule: Oracle Weblogic Server Unauthenticated Remote Code Execution CVE-2023-21839
  desc: Detection the execution of system commands using Oracle Weblogic Server. Possible exploitation of CVE-2023-21839.
  condition: >
    evt.type=clone and
    proc.pname=java and
    not proc.name=java and
    proc.pcmdline contains '-Dweblogic' and
    evt.res exists
  output: "CVE-2023-21839 Remote Code Execution detected (event=%evt.type server_ip=%fd.sip server_port=%fd.sport proto=%fd.l4proto fd.cip=%fd.cip user.name=%user.name user.loginuid=%user.loginuid parent=%proc.pname process=%proc.name evt.arg.args=%evt.arg.args container_id=%container.id)"
  priority: CRITICAL
  tags: [host , container, CVE_2023_21839, weblogic, Mitre_Initial_Access, T1190]


- macro: weblogic_http_get_request
  condition: (evt.arg.data contains 'GET' and evt.arg.data contains '.class' and evt.arg.data contains 'HTTP')

- rule: Oracle Weblogic Server Unauthenticated Remote Code Execution CVE-2023-21839
  desc: Detection the execution of system commands using Oracle Weblogic Server. Possible exploitation of CVE-2023-21839.
  condition: >
    evt.type=write and
    (fd.typechar=4 or fd.typechar=6) and
    proc.name=java and
    weblogic_http_get_request and
    proc.cmdline contains '-Dweblogic'
  output: "CVE-2023-21839 Remote Code Execution detected (event=%evt.type server_ip=%fd.sip server_port=%fd.sport proto=%fd.l4proto fd.cip=%fd.cip user.name=%user.name user.loginuid=%user.loginuid parent=%proc.pname process=%proc.name evt.arg.data=%evt.arg.data container_id=%container.id)"
  priority: CRITICAL
  tags: [host , container, CVE_2023_21839, weblogic, Mitre_Initial_Access, T1190]
